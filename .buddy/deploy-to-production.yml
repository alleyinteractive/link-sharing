- pipeline: "deploy to production"
  on: "EVENT"
  events:
  - type: "PUSH"
    refs:
    - "refs/heads/production"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  actions:
  - action: "Install Composer"
    type: "BUILD"
    working_directory: "/buddy/link-sharing"
    docker_image_name: "alleyops/ci-resources"
    docker_image_tag: "8.1-fpm-wp"
    execute_commands:
    - "ssh-keyscan github.com >> /root/.ssh/known_hosts"
    - "composer install --no-interaction --no-progress --no-dev -o -a --apcu-autoloader --ignore-platform-reqs"
    volume_mappings:
    - "/:/buddy/link-sharing"
    cache_base_image: true
    shell: "BASH"
    run_next_parallel: true
  - action: "Upload files to Park"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    remote_path: "/var/www/link-sharing"
    login: "www-data"
    host: "54.148.134.74"
    port: "22"
    authentication_mode: "PUBLIC_KEY"
    deployment_excludes:
    - "node_modules*/"
    - "*/node_modules/*"
    - "node_modules"
    - ".npm"
    - "tests"
  - action: "Run Migration and Restart Supervisord"
    type: "SSH_COMMAND"
    login: "www-data"
    host: "54.148.134.74"
    port: "22"
    authentication_mode: "PUBLIC_KEY"
    commands:
    - "cd /var/www/link-sharing"
    - "php8.1 artisan migrate --force"
    - ""
    - "# Optimize configuration"
    - "php8.1 $(which composer) optimize-deploy"
    run_as_script: true
    shell: "BASH"
    run_next_parallel: true
